<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  </head>
  <body>
    <div class="page">
      <header class="page-header">
        <h1>IoT Device Monitoring Dashboard</h1>
        <p>Real-time monitoring of device sensors and metrics</p>
        <div class="actions">
          <button id="refreshBtn" type="button">Refresh Devices</button>
          <button id="clearBtn" type="button" class="danger">Clear All Data</button>
        </div>
      </header>
      <section id="deviceList" class="card">
        <h2>Devices</h2>

        <div class="toolbar">
          <input id="deviceSearch" type="search" placeholder="Search devices..." autocomplete="off" />
          <span id="searchCount" class="search-count"></span>
        </div>

        <ul class="device-list">
          {% for device in devices %}
            <li class="device-item" data-device-id="{{ device.device_id|lower }}">
              <div class="device-header">
                <span class="device-id">{{ device.device_id }}</span>
                <span class="updated">
                  {{ device.last_updated if device.last_updated is defined else 'N/A' }}
                </span>
              </div>
              <ul class="metrics">
                <li><label>Current</label><span>{{ device.metrics.current.value if device.metrics.current is defined and device.metrics.current.value is defined else 'N/A' }} A</span></li>
                <li><label>Humidity</label><span>{{ device.metrics.humidity.value if device.metrics.humidity is defined and device.metrics.humidity.value is defined else 'N/A' }} g/kg</span></li>
                <li><label>Power</label><span>{{ device.metrics.power.value if device.metrics.power is defined and device.metrics.power.value is defined else 'N/A' }} W</span></li>
                <li><label>Pressure</label><span>{{ device.metrics.pressure.value if device.metrics.pressure is defined and device.metrics.pressure.value is defined else 'N/A' }} Pa</span></li>
                <li><label>Temperature</label><span>{{ device.metrics.temperature.value if device.metrics.temperature is defined and device.metrics.temperature.value is defined else 'N/A' }} Â°C</span></li>
                <li><label>Voltage</label><span>{{ device.metrics.voltage.value if device.metrics.voltage is defined and device.metrics.voltage.value is defined else 'N/A' }} V</span></li>
              </ul>
            </li>
          {% endfor %}
        </ul>
      </section>
    </div>

    <script>
      // Elements
      const searchInput = document.getElementById('deviceSearch');
      const countEl = document.getElementById('searchCount');
      const deviceItems = Array.from(document.querySelectorAll('.device-item'));

      // Restore search
      const savedSearch = localStorage.getItem('deviceSearch') || '';
      if (savedSearch) searchInput.value = savedSearch;

      function filterDevices() {
        const q = searchInput.value.trim().toLowerCase();
        let visible = 0;
        deviceItems.forEach(li => {
          const id = li.dataset.deviceId;
          if (!q || id.includes(q)) {
            li.style.display = '';
            visible++;
          } else {
            li.style.display = 'none';
          }
        });
        countEl.textContent = visible + '/' + deviceItems.length;
        localStorage.setItem('deviceSearch', searchInput.value);
      }

      searchInput.addEventListener('input', filterDevices);
      filterDevices();

      function reloadPreserveSearch() {
        localStorage.setItem('deviceSearch', searchInput.value);
        location.reload();
      }

      document.getElementById('refreshBtn').onclick = function() {
        localStorage.setItem('deviceSearch', searchInput.value);
        fetch('/api/devices')
          .then(r => r.json())
          .finally(reloadPreserveSearch);
      };

      document.getElementById('clearBtn').onclick = function() {
        if (confirm('Delete all device data?')) {
          fetch('/api/delete-all', { method: 'POST' })
            .then(r => {
              if (r.ok) {
                reloadPreserveSearch();
              } else {
                alert('Failed to clear data.');
              }
            });
        }
      };

      document.querySelectorAll('.device-item').forEach(li => {
        li.addEventListener('click', function() {
          const id = this.dataset.deviceId;
          console.log('Navigating to device:', id);
          window.location.href = `/device/${id}`;
        });
      });

      setInterval(reloadPreserveSearch, 30000);
    </script>
  </body>
</html>
